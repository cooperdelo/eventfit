# Azure Pipelines configuration for Next.js deployment
# This pipeline builds and deploys the Next.js app to Azure App Service

trigger:
  - main
  - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '20.x'
  workingDirectory: 'apps/web'

stages:
  - stage: Build
    displayName: 'Build Next.js Application'
    jobs:
      - job: Build
        displayName: 'Build and Test'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - script: |
              npm ci
            displayName: 'Install Dependencies'
            workingDirectory: $(System.DefaultWorkingDirectory)

          - script: |
              npm run build
            displayName: 'Build Next.js App'
            workingDirectory: $(workingDirectory)

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(workingDirectory)/.next'
              artifactName: 'nextjs-build'
            displayName: 'Publish Build Artifacts'

  - stage: Deploy
    displayName: 'Deploy to Azure App Service'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: Deploy
        displayName: 'Deploy to Azure'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  inputs:
                    azureSubscription: 'YourAzureSubscription'
                    appName: 'YourAppServiceName'
                    package: '$(Pipeline.Workspace)/nextjs-build'
                    startUpCommand: 'npm start'
                  displayName: 'Deploy to Azure App Service'

